{% extends "base.html" %}

{% block title %}Consume Devil Fruit - AEGIS{% endblock %}

{% block content %}
<div class="card-custom">
    <a href="{{ url_for('command_operations') }}" class="btn btn-custom" style="margin-bottom: 2rem;">
        ‚Üê Back to Command Operations Hub
    </a>
    
    <div class="card-header-custom" style="background: linear-gradient(135deg, #553300, #aa6600); border-color: #ffaa00;">
        üçΩÔ∏è RECORD DEVIL FRUIT CONSUMPTION
    </div>
    
    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 2rem;">
        Record that a person has consumed a Devil Fruit
    </p>
    
    {% if message %}
        <div class="alert alert-{{ message_type }}" style="margin-bottom: 2rem;">
            {{ message }}
        </div>
    {% endif %}
    
    {% if people and fruits %}
        <!-- Consumption Recording Form -->
        <form method="POST" class="form-custom">
            <div style="background: linear-gradient(135deg, rgba(85, 51, 0, 0.3), rgba(170, 102, 0, 0.3)); border: 2px solid #ffaa00; border-radius: 15px; padding: 2rem; margin-bottom: 2rem;">
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="person_id" class="form-label" style="color: #ffaa00;">
                            <strong>Select Person *</strong>
                        </label>
                        <select id="person_id" name="person_id" class="form-control" required>
                            <option value="">-- Choose a person --</option>
                            {% for person in people %}
                                <option value="{{ person.Person_ID }}">
                                    {{ person.Person_Name }} 
                                    <span style="color: var(--text-muted);">
                                        ({{ person.Role }})
                                    </span>
                                </option>
                            {% endfor %}
                        </select>
                        <small style="color: var(--text-muted);">Only people without Devil Fruits are shown</small>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="fruit_id" class="form-label" style="color: #ffaa00;">
                            <strong>Select Devil Fruit *</strong>
                        </label>
                        <select id="fruit_id" name="fruit_id" class="form-control" required>
                            <option value="">-- Choose a fruit --</option>
                            {% for fruit in fruits %}
                                <option value="{{ fruit.Fruit_ID }}">
                                    {{ fruit.Fruit_Name }} 
                                    <span class="badge" style="background: {% if fruit.Type == 'Paramecia' %}#ff9900{% elif fruit.Type == 'Zoan' %}#aa00ff{% else %}#00ff00{% endif %}; margin-left: 0.5rem;">
                                        {{ fruit.Type }}
                                    </span>
                                </option>
                            {% endfor %}
                        </select>
                        <small style="color: var(--text-muted);">Only unpossessed fruits are shown</small>
                    </div>
                </div>
                
                <!-- Selected Fruit Details -->
                <div id="fruit_details" style="background: rgba(0, 0, 0, 0.3); border: 2px solid #00ccff; border-radius: 10px; padding: 1.5rem; margin-top: 2rem; display: none;">
                    <h4 style="color: #00ccff; margin-bottom: 1rem;">üçé Selected Fruit Ability</h4>
                    <p id="ability_text" style="color: var(--text-secondary); line-height: 1.6;"></p>
                </div>
                
                <div class="alert alert-danger" style="background: rgba(255, 0, 0, 0.3); border: 3px solid #ff0000; margin-top: 2rem; color: #ffffff;">
                    <strong style="color: #ff0000; font-size: 1.2rem;">‚ö†Ô∏è CRITICAL RULES:</strong>
                    <ul style="margin-top: 0.5rem; margin-bottom: 0; color: #ffcccc; line-height: 1.8;">
                        <li><strong style="color: #ff6666;">Each person can only possess ONE Devil Fruit</strong></li>
                        <li><strong style="color: #ff6666;">Each Devil Fruit can only be possessed by ONE person</strong></li>
                        <li><strong style="color: #ff6666;">Consuming a second Devil Fruit results in death</strong> (not enforced in DB)</li>
                        <li><strong style="color: #ff6666;">This operation cannot be undone easily</strong></li>
                    </ul>
                </div>
                
                <div style="margin-top: 2rem; text-align: center;">
                    <button type="submit" class="btn btn-custom" style="background: #cc8800; border-color: #ffaa00; padding: 0.75rem 3rem; font-size: 1.1rem;">
                        ‚úÖ Record Consumption
                    </button>
                </div>
            </div>
        </form>
        
    {% elif not people %}
        <div class="alert alert-warning" style="text-align: center;">
            <h4>üë• No Available People</h4>
            <p style="margin-top: 1rem; color: var(--text-secondary);">
                All registered people already possess Devil Fruits. To record consumption:
            </p>
            <ol style="text-align: left; margin: 1rem auto; max-width: 600px; color: var(--text-secondary);">
                <li>Register a new person using the "Register Criminal" operation</li>
                <li>Return here to record their Devil Fruit consumption</li>
            </ol>
        </div>
        
    {% elif not fruits %}
        <div class="alert alert-warning" style="text-align: center;">
            <h4>üçé No Available Devil Fruits</h4>
            <p style="margin-top: 1rem; color: var(--text-secondary);">
                All logged Devil Fruits are already possessed. To record consumption:
            </p>
            <ol style="text-align: left; margin: 1rem auto; max-width: 600px; color: var(--text-secondary);">
                <li>Log a new Devil Fruit using the "Log Devil Fruit" operation</li>
                <li>Return here to record its consumption</li>
            </ol>
            <a href="{{ url_for('log_devil_fruit') }}" class="btn btn-custom" style="margin-top: 1rem; background: #00aa00; border-color: #00ff00;">
                ‚Üí Log New Devil Fruit
            </a>
        </div>
    {% endif %}
    
    <!-- Guidelines -->
    <div style="background: rgba(0, 0, 0, 0.3); border: 2px solid var(--border-color); border-radius: 10px; padding: 1.5rem;">
        <h4 style="color: #ffaa00; margin-bottom: 1rem;">üìã Consumption Guidelines</h4>
        <ul style="color: var(--text-secondary); line-height: 1.8;">
            <li><strong style="color: #00ccff;">One Fruit Rule:</strong> Each person can only possess one Devil Fruit</li>
            <li><strong style="color: #00ccff;">Uniqueness:</strong> Each fruit can only be possessed by one person at a time</li>
            <li><strong style="color: #00ccff;">Validation:</strong> System automatically checks for existing possessions</li>
            <li><strong style="color: #00ccff;">Swimming Ability:</strong> Devil Fruit users cannot swim (not enforced in DB)</li>
            <li><strong style="color: #00ccff;">Power Transfer:</strong> Fruit reincarnates if user dies (not auto-tracked)</li>
        </ul>
    </div>
</div>

<script>
// Show fruit ability when selected
document.getElementById('fruit_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const fruitDetails = document.getElementById('fruit_details');
    const abilityText = document.getElementById('ability_text');
    
    if (this.value) {
        // Extract ability from data attribute (we'll need to add this to the option)
        const fruits = {{ fruits|tojson }};
        const selectedFruit = fruits.find(f => f.Fruit_ID == this.value);
        
        if (selectedFruit && selectedFruit.Ability) {
            abilityText.textContent = selectedFruit.Ability;
            fruitDetails.style.display = 'block';
        } else {
            abilityText.textContent = 'No ability description available.';
            fruitDetails.style.display = 'block';
        }
    } else {
        fruitDetails.style.display = 'none';
    }
});
</script>
{% endblock %}
