{% extends "base.html" %}

{% block title %}Update Devil Fruit Possession - AEGIS{% endblock %}

{% block content %}
<div class="card-custom">
    <a href="{{ url_for('command_operations') }}" class="btn btn-custom" style="margin-bottom: 2rem;">
        ‚Üê Back to Command Operations Hub
    </a>
    
    <div class="card-header-custom" style="background: linear-gradient(135deg, #553300, #aa6600); border-color: #ffaa00;">
        üîÑ UPDATE DEVIL FRUIT POSSESSION
    </div>
    
    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 2rem;">
        Transfer Devil Fruit from current owner to a new person
    </p>
    
    {% if message %}
        <div class="alert alert-{{ message_type }}" style="margin-bottom: 2rem;">
            {{ message }}
        </div>
    {% endif %}
    
    {% if fruits and people %}
        <!-- Update Possession Form -->
        <form method="POST" class="form-custom">
            <div style="background: linear-gradient(135deg, rgba(85, 51, 0, 0.3), rgba(170, 102, 0, 0.3)); border: 2px solid #ffaa00; border-radius: 15px; padding: 2rem; margin-bottom: 2rem;">
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="fruit_id" class="form-label" style="color: #ffaa00;">
                            <strong>Select Devil Fruit *</strong>
                        </label>
                        <select id="fruit_id" name="fruit_id" class="form-control" required>
                            <option value="">-- Choose a fruit --</option>
                            {% for fruit in fruits %}
                                <option value="{{ fruit.Fruit_ID }}" 
                                        data-current-owner="{{ fruit.Current_Owner_Name or 'None' }}"
                                        data-description="{{ fruit.Description }}">
                                    {{ fruit.Fruit_Name }} 
                                    <span class="badge" style="background: {% if fruit.Type == 'Paramecia' %}#ff9900{% elif fruit.Type == 'Zoan' %}#aa00ff{% else %}#00ff00{% endif %}; margin-left: 0.5rem;">
                                        {{ fruit.Type }}
                                    </span>
                                    {% if fruit.Current_Owner_Name %}
                                        - Currently: {{ fruit.Current_Owner_Name }}
                                    {% else %}
                                        - Unpossessed
                                    {% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        <small style="color: var(--text-muted);">Select fruit to transfer</small>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="new_person_id" class="form-label" style="color: #ffaa00;">
                            <strong>New Owner (Person) *</strong>
                        </label>
                        <select id="new_person_id" name="new_person_id" class="form-control" required>
                            <option value="">-- Choose new owner --</option>
                            {% for person in people %}
                                <option value="{{ person.Person_ID }}">
                                    {{ person.Person_Name }} 
                                    <span style="color: var(--text-muted);">
                                        ({{ person.Status }})
                                    </span>
                                </option>
                            {% endfor %}
                        </select>
                        <small style="color: var(--text-muted);">Only people without Devil Fruits are shown</small>
                    </div>
                </div>
                
                <!-- Current Owner Info -->
                <div id="current_owner_info" style="background: rgba(0, 0, 0, 0.3); border: 2px solid #ffaa00; border-radius: 10px; padding: 1.5rem; margin-top: 2rem; display: none;">
                    <h4 style="color: #ffaa00; margin-bottom: 1rem;">üìã Current Possession Info</h4>
                    <p style="color: var(--text-secondary);">
                        <strong style="color: #00ccff;">Current Owner:</strong> <span id="current_owner_text">None</span>
                    </p>
                    <p style="color: var(--text-secondary); margin-bottom: 0;">
                        <strong style="color: #00ccff;">Ability:</strong> <span id="ability_text">-</span>
                    </p>
                </div>
                
                <div class="alert alert-info" style="background: rgba(0, 204, 255, 0.2); border: 3px solid #00ccff; margin-top: 2rem; color: #ffffff;">
                    <strong style="color: #00ccff; font-size: 1.2rem;">‚ÑπÔ∏è UPDATE OPERATION:</strong>
                    <ul style="margin-top: 0.5rem; margin-bottom: 0; color: #ccf2ff; line-height: 1.8;">
                        <li><strong style="color: #66d9ff;">This is an UPDATE operation</strong> - transfers fruit to new owner</li>
                        <li><strong style="color: #66d9ff;">Previous owner will lose the fruit</strong></li>
                        <li><strong style="color: #66d9ff;">New owner cannot already have a Devil Fruit</strong></li>
                        <li><strong style="color: #66d9ff;">Use this for fruit reincarnation scenarios</strong></li>
                    </ul>
                </div>
                
                <div style="margin-top: 2rem; text-align: center;">
                    <button type="submit" class="btn btn-custom" style="background: #cc8800; border-color: #ffaa00; padding: 0.75rem 3rem; font-size: 1.1rem;">
                        üîÑ Transfer Possession
                    </button>
                </div>
            </div>
        </form>
        
    {% elif not people %}
        <div class="alert alert-warning" style="text-align: center;">
            <h4>üë• No Available People</h4>
            <p style="margin-top: 1rem; color: var(--text-secondary);">
                All registered people already possess Devil Fruits. To transfer a fruit:
            </p>
            <ol style="text-align: left; margin: 1rem auto; max-width: 600px; color: var(--text-secondary);">
                <li>Register a new person using the "Register Criminal" operation</li>
                <li>Or remove an existing fruit possession first</li>
                <li>Return here to transfer the fruit</li>
            </ol>
        </div>
        
    {% elif not fruits %}
        <div class="alert alert-warning" style="text-align: center;">
            <h4>üçé No Devil Fruits Found</h4>
            <p style="margin-top: 1rem; color: var(--text-secondary);">
                No Devil Fruits are registered in the system. To transfer fruits:
            </p>
            <ol style="text-align: left; margin: 1rem auto; max-width: 600px; color: var(--text-secondary);">
                <li>Log a new Devil Fruit using the "Log Devil Fruit" operation</li>
                <li>Return here to manage possession</li>
            </ol>
            <a href="{{ url_for('log_devil_fruit') }}" class="btn btn-custom" style="margin-top: 1rem; background: #00aa00; border-color: #00ff00;">
                ‚Üí Log New Devil Fruit
            </a>
        </div>
    {% endif %}
    
    <!-- Guidelines -->
    <div style="background: rgba(0, 0, 0, 0.3); border: 2px solid var(--border-color); border-radius: 10px; padding: 1.5rem;">
        <h4 style="color: #ffaa00; margin-bottom: 1rem;">üìã Update Guidelines</h4>
        <ul style="color: var(--text-secondary); line-height: 1.8;">
            <li><strong style="color: #00ccff;">Transfer Operation:</strong> This updates existing possession records</li>
            <li><strong style="color: #00ccff;">Fruit Reincarnation:</strong> When a user dies, fruit reappears elsewhere</li>
            <li><strong style="color: #00ccff;">One Fruit Rule:</strong> New owner must not already have a Devil Fruit</li>
            <li><strong style="color: #00ccff;">Previous Owner:</strong> Will automatically lose possession when transferred</li>
            <li><strong style="color: #00ccff;">Complete Removal:</strong> Use "Remove Fruit Possession" to delete records entirely</li>
        </ul>
    </div>
</div>

<script>
// Show current owner and ability when fruit is selected
document.getElementById('fruit_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const currentOwnerInfo = document.getElementById('current_owner_info');
    const currentOwnerText = document.getElementById('current_owner_text');
    const abilityText = document.getElementById('ability_text');
    
    if (this.value) {
        const currentOwner = selectedOption.getAttribute('data-current-owner');
        const description = selectedOption.getAttribute('data-description');
        
        currentOwnerText.textContent = currentOwner || 'None (Unpossessed)';
        abilityText.textContent = description || 'No description available';
        currentOwnerInfo.style.display = 'block';
    } else {
        currentOwnerInfo.style.display = 'none';
    }
});
</script>
{% endblock %}
