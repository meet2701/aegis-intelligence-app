{% extends "base.html" %}

{% block title %}Historical Event Summary - Aegis Intelligence Database{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="page-header">
        <h1>üìú Historical Event Summary</h1>
        <p class="subtitle">Comprehensive archive of major world events, battles, and incidents with participating factions</p>
        <p class="description">
            <strong>Analysis Scope:</strong> Event ‚Üí Encounter ‚Üí Crew/Marine/Island relationships with temporal analysis. 
            Tracks historical incidents, battle participants, geographic locations, and event duration metrics.
        </p>
    </div>

    {% if results %}
    <div class="results-summary">
        <span class="result-count">üìÖ Event Count: <strong>{{ results|length }}</strong></span>
        <span class="timestamp">Report Generated: {{ now.strftime('%Y-%m-%d %H:%M:%S') }}</span>
    </div>

    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Event ID</th>
                    <th>Event Name</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Duration (Days)</th>
                    <th>Involved Crews</th>
                    <th>Involved Marines</th>
                    <th>Location</th>
                    <th>Region</th>
                    <th>Participating Crews</th>
                </tr>
            </thead>
            <tbody>
                {% for row in results %}
                <tr>
                    <td>{{ row.Event_ID }}</td>
                    <td><strong>{{ row.Event_Name }}</strong></td>
                    <td>{{ row.Start_Date.strftime('%Y-%m-%d') if row.Start_Date else '<span class="null-value">Unknown</span>' }}</td>
                    <td>
                        {% if row.End_Date %}
                            {{ row.End_Date.strftime('%Y-%m-%d') }}
                        {% else %}
                            <span class="ongoing-badge">ONGOING</span>
                        {% endif %}
                    </td>
                    <td>{{ row.Duration_Days if row.Duration_Days else '<span class="null-value">N/A</span>' }}</td>
                    <td class="center-align">{{ row.Involved_Crews }}</td>
                    <td class="center-align">{{ row.Involved_Marines }}</td>
                    <td>{{ row.Location if row.Location else '<span class="null-value">Unknown</span>' }}</td>
                    <td>{{ row.Region if row.Region else '<span class="null-value">N/A</span>' }}</td>
                    <td class="crew-list">
                        {% if row.Crew_Names %}
                            {{ row.Crew_Names }}
                        {% else %}
                            <span class="null-value">No recorded crews</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="event-stats">
        <h3>üìä Event Statistics</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Events</div>
                <div class="stat-value">{{ results|length }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Ongoing Events</div>
                <div class="stat-value">{{ results|selectattr('End_Date', 'none')|list|length }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Completed Events</div>
                <div class="stat-value">{{ results|rejectattr('End_Date', 'none')|list|length }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Duration</div>
                <div class="stat-value">
                    {% set durations = results|selectattr('Duration_Days', 'number')|map(attribute='Duration_Days')|list %}
                    {% if durations %}
                        {{ "%.0f"|format(durations|sum / durations|length) }} days
                    {% else %}
                        N/A
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="legend">
        <h3>üìñ Event Metrics Explained</h3>
        <ul>
            <li><strong>Event:</strong> Major historical incident recorded in World Government archives</li>
            <li><strong>Encounter:</strong> Specific instance of crew/marine involvement at event location</li>
            <li><strong>Duration:</strong> Days between Start_Date and End_Date (or current date if ongoing)</li>
            <li><strong>Involved Crews:</strong> Distinct pirate crews with Encounter records at this event</li>
            <li><strong>Involved Marines:</strong> Count of Marine Officers recorded at encounter sites</li>
            <li><strong>Location:</strong> Primary island where event took place</li>
        </ul>
    </div>

    {% else %}
    <div class="no-results">
        <p>‚ö†Ô∏è No historical events recorded in the database.</p>
        <p>Events include major battles (Marineford War), incidents (Rocky Port), and historical turning points (God Valley).</p>
    </div>
    {% endif %}

    <div class="action-buttons">
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
    </div>
</div>

<style>
.ongoing-badge {
    background: var(--warning-color);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 0.85em;
}

.center-align {
    text-align: center;
}

.crew-list {
    max-width: 300px;
    word-wrap: break-word;
    font-size: 0.9em;
}

.event-stats {
    margin: 30px 0;
    padding: 20px;
    background: var(--surface-color);
    border-radius: 8px;
}

.event-stats h3 {
    margin-top: 0;
    color: var(--primary-color);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.stat-card {
    background: var(--background-color);
    padding: 20px;
    border-radius: 8px;
    border: 2px solid var(--border-color);
    text-align: center;
}

.stat-label {
    color: var(--text-muted);
    font-size: 0.9em;
    margin-bottom: 10px;
}

.stat-value {
    font-size: 2em;
    font-weight: bold;
    color: var(--primary-color);
}

.legend {
    margin-top: 30px;
    padding: 20px;
    background: var(--surface-color);
    border-left: 4px solid var(--primary-color);
    border-radius: 8px;
}

.legend h3 {
    margin-top: 0;
    color: var(--primary-color);
}

.legend ul {
    list-style-type: none;
    padding-left: 0;
}

.legend li {
    padding: 8px 0;
    border-bottom: 1px solid var(--border-color);
}

.legend li:last-child {
    border-bottom: none;
}

.null-value {
    color: var(--text-muted);
    font-style: italic;
}

.description {
    background: var(--surface-color);
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border-left: 4px solid var(--info-color);
}
</style>
{% endblock %}
